{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#zalmoxis-exoplanet-interior-structure-model","title":"Zalmoxis (Exoplanet Interior Structure Model)","text":"<p>Zalmoxis is a program designed to model the internal structure of exoplanets using an iterative numerical approach.</p>"},{"location":"#installation-run-instructions","title":"Installation &amp; run instructions","text":"<p>See the installation guide and usage guide for more information.</p>"},{"location":"#repository-structure","title":"Repository structure","text":"Object Description <code>README.md</code> Overview file <code>pyproject.toml</code> Project configuration file <code>CODE_OF_CONDUCT.md</code> Project code of conduct <code>LICENSE.txt</code> Project license <code>src/zalmoxis</code> Source code for Zalmoxis <code>input/</code> Configuration files for running the model <code>docs/</code> Documentation source files <code>src/tests/</code> Tests for the model"},{"location":"CODE_OF_CONDUCT/","title":"Contributor Covenant Code of Conduct","text":""},{"location":"CODE_OF_CONDUCT/#our-pledge","title":"Our Pledge","text":"<p>We as members, contributors, and leaders pledge to make participation in our community a harassment-free experience for everyone, regardless of age, body size, visible or invisible disability, ethnicity, sex characteristics, gender identity and expression, level of experience, education, socio-economic status, nationality, personal appearance, race, religion, or sexual identity and orientation.</p> <p>We pledge to act and interact in ways that contribute to an open, welcoming, diverse, inclusive, and healthy community.</p>"},{"location":"CODE_OF_CONDUCT/#our-standards","title":"Our Standards","text":"<p>Examples of behavior that contributes to a positive environment for our community include:</p> <ul> <li>Demonstrating empathy and kindness toward other people</li> <li>Being respectful of differing opinions, viewpoints, and experiences</li> <li>Giving and gracefully accepting constructive feedback</li> <li>Accepting responsibility and apologizing to those affected by our mistakes,   and learning from the experience</li> <li>Focusing on what is best not just for us as individuals, but for the   overall community</li> </ul> <p>Examples of unacceptable behavior include:</p> <ul> <li>The use of sexualized language or imagery, and sexual attention or   advances of any kind</li> <li>Trolling, insulting or derogatory comments, and personal or political attacks</li> <li>Public or private harassment</li> <li>Publishing others' private information, such as a physical or email   address, without their explicit permission</li> <li>Other conduct which could reasonably be considered inappropriate in a   professional setting</li> </ul>"},{"location":"CODE_OF_CONDUCT/#enforcement-responsibilities","title":"Enforcement Responsibilities","text":"<p>Community leaders are responsible for clarifying and enforcing our standards of acceptable behavior and will take appropriate and fair corrective action in response to any behavior that they deem inappropriate, threatening, offensive, or harmful.</p> <p>Community leaders have the right and responsibility to remove, edit, or reject comments, commits, code, wiki edits, issues, and other contributions that are not aligned to this Code of Conduct, and will communicate reasons for moderation decisions when appropriate.</p>"},{"location":"CODE_OF_CONDUCT/#scope","title":"Scope","text":"<p>This Code of Conduct applies within all community spaces, and also applies when an individual is officially representing the community in public spaces. Examples of representing our community include using an official e-mail address, posting via an official social media account, or acting as an appointed representative at an online or offline event.</p>"},{"location":"CODE_OF_CONDUCT/#enforcement","title":"Enforcement","text":"<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be reported to the community leaders responsible for enforcement at contact@formingworlds.space. All complaints will be reviewed and investigated promptly and fairly.</p> <p>All community leaders are obligated to respect the privacy and security of the reporter of any incident.</p>"},{"location":"CODE_OF_CONDUCT/#enforcement-guidelines","title":"Enforcement Guidelines","text":"<p>Community leaders will follow these Community Impact Guidelines in determining the consequences for any action they deem in violation of this Code of Conduct:</p>"},{"location":"CODE_OF_CONDUCT/#1-correction","title":"1. Correction","text":"<p>Community Impact: Use of inappropriate language or other behavior deemed unprofessional or unwelcome in the community.</p> <p>Consequence: A private, written warning from community leaders, providing clarity around the nature of the violation and an explanation of why the behavior was inappropriate. A public apology may be requested.</p>"},{"location":"CODE_OF_CONDUCT/#2-warning","title":"2. Warning","text":"<p>Community Impact: A violation through a single incident or series of actions.</p> <p>Consequence: A warning with consequences for continued behavior. No interaction with the people involved, including unsolicited interaction with those enforcing the Code of Conduct, for a specified period of time. This includes avoiding interactions in community spaces as well as external channels like social media. Violating these terms may lead to a temporary or permanent ban.</p>"},{"location":"CODE_OF_CONDUCT/#3-temporary-ban","title":"3. Temporary Ban","text":"<p>Community Impact: A serious violation of community standards, including sustained inappropriate behavior.</p> <p>Consequence: A temporary ban from any sort of interaction or public communication with the community for a specified period of time. No public or private interaction with the people involved, including unsolicited interaction with those enforcing the Code of Conduct, is allowed during this period. Violating these terms may lead to a permanent ban.</p>"},{"location":"CODE_OF_CONDUCT/#4-permanent-ban","title":"4. Permanent Ban","text":"<p>Community Impact: Demonstrating a pattern of violation of community standards, including sustained inappropriate behavior,  harassment of an individual, or aggression toward or disparagement of classes of individuals.</p> <p>Consequence: A permanent ban from any sort of public interaction within the community.</p>"},{"location":"CODE_OF_CONDUCT/#attribution","title":"Attribution","text":"<p>This Code of Conduct is adapted from the Contributor Covenant, version 2.0, available at https://www.contributor-covenant.org/version/2/0/code_of_conduct.html.</p> <p>Community Impact Guidelines were inspired by Mozilla's code of conduct enforcement ladder.</p> <p>For answers to common questions about this code of conduct, see the FAQ at https://www.contributor-covenant.org/faq. Translations are available at https://www.contributor-covenant.org/translations.</p>"},{"location":"CONTRIBUTING/","title":"Contributing guidelines","text":""},{"location":"CONTRIBUTING/#development","title":"Development","text":""},{"location":"CONTRIBUTING/#setup","title":"Setup","text":"<p>Install Zalmoxis with development dependencies:</p> <pre><code>pip install -e \".[develop]\"\n</code></pre> <p>This includes pytest, pytest-xdist (parallel test execution), ruff (linting/formatting), coverage tools, and pre-commit hooks.</p>"},{"location":"CONTRIBUTING/#testing","title":"Testing","text":"<p>Tests are categorized by speed using pytest markers:</p> <pre><code>pytest -m unit          # ~2s   -- EOS functions, no solver\npytest -m integration   # ~10min -- full solver validation\npytest -m slow          # ~30min -- composition grid sweep\npytest -m \"not slow\"    # everything except the slow grid sweep\npytest                  # all tests in parallel\n</code></pre> <p>Run <code>pytest -m unit</code> as a fast feedback loop during development. The full suite runs automatically on PRs.</p> <p>When adding or modifying code, add or update tests in <code>src/tests/</code> to match. See the Testing documentation for the full guide on markers, fixtures, and test structure.</p>"},{"location":"CONTRIBUTING/#linting","title":"Linting","text":"<pre><code>ruff check --fix src/ tests/\nruff format src/ tests/\n</code></pre>"},{"location":"CONTRIBUTING/#building-the-documentation","title":"Building the documentation","text":"<p>The documentation is written in markdown, and uses mkdocs to generate the pages.</p> <p>To build the documentation for yourself in editable mode:</p> <pre><code>pip install -e .[docs]\nmkdocs serve\n</code></pre> <p>This will generate the pages and serve them on a local development server. Copy the displayed URL (typically <code>http://127.0.0.1:8000</code>) into your browser to view the documentation as you edit.</p> <p>You can find the documentation source in the docs directory. If you are adding new pages, make sure to update the listing in the <code>mkdocs.yml</code> under the <code>nav</code> entry.</p>"},{"location":"configuration/","title":"Configuration file","text":"<p>Zalmoxis uses TOML to structure its configuration file. The default is <code>default.toml</code> in the <code>input/</code> directory.</p> <p>The configuration file defines all parameters needed to run the planetary interior structure model: planet properties, equation of state (EOS) selection for each structural layer, numerical solver settings, and output options. The sections below document each parameter.</p>"},{"location":"configuration/#configuration-sections","title":"Configuration sections","text":""},{"location":"configuration/#inputparameter","title":"<code>InputParameter</code>","text":"<p>Defines the basic input for the planetary model.</p> Parameter Type Unit Description <code>planet_mass</code> float Earth masses Total planet mass (\\(M_\\oplus = 5.972 \\times 10^{24}\\) kg)."},{"location":"configuration/#assumptionsandinitialguesses","title":"<code>AssumptionsAndInitialGuesses</code>","text":"<p>Initial guesses and assumptions for the planetary structure.</p> Parameter Type Unit Description <code>core_mass_fraction</code> float -- Core mass as a fraction of total mass. Also used in the Seager et al. (2007) scaling relation for the initial radius guess. Earth: ~0.325. <code>mantle_mass_fraction</code> float -- Mantle mass as a fraction of total mass. Set to 0 for a 2-layer model where the mantle fills the remainder (1 - <code>core_mass_fraction</code>). Must be &gt; 0 when using a 3-layer model with an ice layer. <code>temperature_mode</code> string -- Temperature profile type. One of: <code>\"isothermal\"</code>, <code>\"linear\"</code>, <code>\"prescribed\"</code>. See Temperature profiles. <code>surface_temperature</code> float K Surface temperature. Used when <code>temperature_mode</code> is <code>\"isothermal\"</code> or <code>\"linear\"</code>. <code>center_temperature</code> float K Central temperature. Used when <code>temperature_mode</code> is <code>\"linear\"</code>. <code>temperature_profile_file</code> string -- Filename (relative to <code>input/</code>) containing a prescribed radial temperature profile. Used when <code>temperature_mode</code> is <code>\"prescribed\"</code>."},{"location":"configuration/#temperature-profiles","title":"Temperature profiles","text":"<p>Temperature profiles are only relevant when using a temperature-dependent EOS (i.e., <code>WolfBower2018:MgSiO3</code> or <code>RTPress100TPa:MgSiO3</code>). For all other EOS choices, a fixed 300 K is assumed internally and these parameters are ignored.</p> <ul> <li><code>\"isothermal\"</code>: Constant temperature equal to <code>surface_temperature</code> at all radii.</li> <li><code>\"linear\"</code>: Linear interpolation from <code>center_temperature</code> at \\(r = 0\\) to <code>surface_temperature</code> at \\(r = R\\).</li> <li><code>\"prescribed\"</code>: Reads a temperature profile from <code>temperature_profile_file</code>. The file must contain one temperature value per line (in K), ordered from center to surface, with the same number of entries as <code>num_layers</code>.</li> </ul>"},{"location":"configuration/#eos","title":"<code>EOS</code>","text":"<p>Specifies the equation of state for each structural layer. Each layer is configured independently using a <code>\"&lt;source&gt;:&lt;composition&gt;\"</code> string.</p> <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"WolfBower2018:MgSiO3\"\nice_layer = \"\"  # Empty string = 2-layer model\n</code></pre> <p>Fields:</p> Field Required Description <code>core</code> Yes EOS for the innermost layer (iron core). <code>mantle</code> Yes EOS for the mantle layer. <code>ice_layer</code> No EOS for an outer volatile layer. If empty or omitted, the model uses a 2-layer structure (core + mantle). If set, the model uses a 3-layer structure and <code>mantle_mass_fraction</code> must be &gt; 0 in <code>[AssumptionsAndInitialGuesses]</code>."},{"location":"configuration/#naming-convention","title":"Naming convention","text":"<p>All EOS identifiers follow the format <code>&lt;source&gt;:&lt;composition&gt;</code>, where:</p> <ul> <li><code>&lt;source&gt;</code> identifies the data source or method: <code>Seager2007</code> (tabulated), <code>WolfBower2018</code> (tabulated, temperature-dependent), or <code>Analytic</code> (closed-form fit, no data files needed).</li> <li><code>&lt;composition&gt;</code> identifies the material: <code>iron</code>, <code>MgSiO3</code>, <code>MgFeSiO3</code>, <code>H2O</code>, <code>graphite</code>, <code>SiC</code>.</li> </ul>"},{"location":"configuration/#available-eos-options","title":"Available EOS options","text":"EOS string Source Composition Temperature Data files required Notes <code>Seager2007:iron</code> Seager et al. (2007) Fe (epsilon phase) Fixed 300 K Yes Vinet EOS + DFT, tabulated \\(\\rho(P)\\). <code>Seager2007:MgSiO3</code> Seager et al. (2007) MgSiO3 perovskite Fixed 300 K Yes 4th-order Birch-Murnaghan + DFT, tabulated \\(\\rho(P)\\). <code>Seager2007:H2O</code> Seager et al. (2007) Water ice (phases VII, VIII, X) Fixed 300 K Yes Experimental + DFT, tabulated \\(\\rho(P)\\). <code>WolfBower2018:MgSiO3</code> Wolf &amp; Bower (2018) MgSiO3 (melt + solid) T-dependent Yes RTpress EOS with phase-aware melting (solid EOS derived from Mosenfelder et al. 2009). Limited to \\(\\leq 7\\,M_\\oplus\\) (table max ~1 TPa; out-of-bounds pressures clamped). Requires <code>temperature_mode</code> configuration. Uses Monteux et al. solidus/liquidus curves. <code>RTPress100TPa:MgSiO3</code> Extended RTpress melt table MgSiO3 (melt + solid) T-dependent Yes Extended melt EOS to 100 TPa (\\(P\\): \\(10^3\\)--\\(10^{14}\\) Pa, \\(T\\): 400--50000 K). Solid phase uses Wolf &amp; Bower (2018) table (clamped at 1 TPa). Limited to \\(\\leq 50\\,M_\\oplus\\). Requires <code>temperature_mode</code> configuration. Uses same Monteux et al. solidus/liquidus curves. <code>Analytic:iron</code> Seager et al. (2007) Table 3 Fe (epsilon) Fixed 300 K No Modified polytrope: \\(\\rho(P) = \\rho_0 + c \\cdot P^n\\). <code>Analytic:MgSiO3</code> Seager et al. (2007) Table 3 MgSiO3 perovskite Fixed 300 K No Modified polytrope. <code>Analytic:MgFeSiO3</code> Seager et al. (2007) Table 3 (Mg,Fe)SiO3 Fixed 300 K No Modified polytrope. <code>Analytic:H2O</code> Seager et al. (2007) Table 3 Water ice Fixed 300 K No Modified polytrope. <code>Analytic:graphite</code> Seager et al. (2007) Table 3 C (graphite) Fixed 300 K No Modified polytrope. <code>Analytic:SiC</code> Seager et al. (2007) Table 3 Silicon carbide Fixed 300 K No Modified polytrope. <p>Analytic EOS details. The analytic options use the modified polytropic fit from Seager et al. (2007, Eq. 11, Table 3):</p> \\[\\rho(P) = \\rho_0 + c \\cdot P^n\\] <p>where \\(\\rho_0\\) is the zero-pressure density, \\(c\\) and \\(n\\) are fitted constants. This approximation is valid for \\(P &lt; 10^{16}\\) Pa and reproduces the full tabulated EOS to 2--12% accuracy across all planetary pressures. The analytic EOS requires no external data files, making it useful for quick exploration and testing.</p> <p>Temperature-dependent EOS. Two temperature-dependent EOS options are available: <code>WolfBower2018:MgSiO3</code> (melt table up to 1 TPa, \\(\\leq 7\\,M_\\oplus\\)) and <code>RTPress100TPa:MgSiO3</code> (extended melt table up to 100 TPa, \\(\\leq 50\\,M_\\oplus\\)). Both use separate tabulated \\(\\rho(P, T)\\) grids for solid and melt phases, with a linear melt-fraction interpolation between the solidus and liquidus. The <code>RTPress100TPa:MgSiO3</code> option uses the same solid table and melting curves as <code>WolfBower2018:MgSiO3</code> but extends the melt EOS to much higher pressures and temperatures, enabling modeling of super-Earths up to ~50 \\(M_\\oplus\\). When either EOS is assigned to any layer, the <code>temperature_mode</code>, <code>surface_temperature</code>, and <code>center_temperature</code> parameters in <code>[AssumptionsAndInitialGuesses]</code> become active.</p> <p>Mass limits for temperature-dependent EOS</p> <p>WolfBower2018:MgSiO3: Tables cover pressures up to ~1 TPa. For planets above ~2 \\(M_\\oplus\\), deep-mantle pressures begin to exceed this limit. The Brent pressure solver with out-of-bounds clamping handles this gracefully up to \\(7\\,M_\\oplus\\). Beyond \\(7\\,M_\\oplus\\), clamped densities become unreliable and the code raises a <code>ValueError</code>. Use <code>RTPress100TPa:MgSiO3</code> for higher-mass planets with a temperature-dependent mantle.</p> <p>RTPress100TPa:MgSiO3: The extended melt table covers pressures up to 100 TPa, enabling modeling of super-Earths up to ~\\(50\\,M_\\oplus\\). The solid-phase table remains limited to 1 TPa (clamped at boundary), but at the high temperatures typical of massive planets the mantle is predominantly molten, so this limitation is less constraining.</p>"},{"location":"configuration/#eos-decision-guide","title":"EOS decision guide","text":"<p>Use tabulated EOS (<code>Seager2007:*</code>, <code>WolfBower2018:*</code>) when:</p> <ul> <li>Accuracy matters (e.g., comparison with published mass-radius relations).</li> <li>Data files are available (downloaded via <code>get_data.sh</code> or equivalent).</li> <li>Temperature-dependent phase behavior is needed (mantle melting).</li> </ul> <p>Use analytic EOS (<code>Analytic:*</code>) when:</p> <ul> <li>Running quick parameter sweeps or exploratory calculations.</li> <li>Data files are not yet downloaded or not available.</li> <li>Exotic compositions are needed (graphite, SiC, MgFeSiO3) that have no tabulated counterpart.</li> <li>Testing or debugging the structure solver.</li> </ul> <p>Mixing tabulated and analytic EOS across layers is fully supported. For example, a tabulated iron core with an analytic silicate mantle is a valid configuration.</p>"},{"location":"configuration/#configuration-examples","title":"Configuration examples","text":"<p>Earth-like planet (iron core + silicate mantle, 2-layer): <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"Seager2007:MgSiO3\"\nice_layer = \"\"\n</code></pre></p> <p>Earth-like with temperature-dependent mantle (iron core + T-dependent silicate, 2-layer): <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"WolfBower2018:MgSiO3\"\nice_layer = \"\"\n</code></pre> Requires <code>temperature_mode</code>, <code>surface_temperature</code>, and <code>center_temperature</code> to be set in <code>[AssumptionsAndInitialGuesses]</code>.</p> <p>Super-Earth with extended T-dependent mantle (iron core + RTPress100TPa silicate, 2-layer, up to 50 \\(M_\\oplus\\)): <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"RTPress100TPa:MgSiO3\"\nice_layer = \"\"\n</code></pre> Same temperature configuration as <code>WolfBower2018:MgSiO3</code> but with extended pressure and temperature coverage for massive rocky planets.</p> <p>Mercury-like planet (large iron core + (Mg,Fe)SiO3 mantle, analytic): <pre><code>[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.68\n# ...\n\n[EOS]\ncore      = \"Analytic:iron\"\nmantle    = \"Analytic:MgFeSiO3\"\nice_layer = \"\"\n</code></pre></p> <p>Water world (iron core + silicate mantle + water ice layer, 3-layer): <pre><code>[AssumptionsAndInitialGuesses]\ncore_mass_fraction   = 0.25\nmantle_mass_fraction = 0.50\n# ...\n\n[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"Seager2007:MgSiO3\"\nice_layer = \"Seager2007:H2O\"\n</code></pre> Note: <code>mantle_mass_fraction</code> must be &gt; 0 for a 3-layer model.</p> <p>Carbon planet (iron core + SiC mantle): <pre><code>[EOS]\ncore      = \"Analytic:iron\"\nmantle    = \"Analytic:SiC\"\nice_layer = \"\"\n</code></pre></p> <p>Carbon planet with graphite mantle: <pre><code>[EOS]\ncore      = \"Analytic:iron\"\nmantle    = \"Analytic:graphite\"\nice_layer = \"\"\n</code></pre></p> <p>Mixed-EOS model (tabulated core + analytic mantle): <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"Analytic:MgSiO3\"\nice_layer = \"\"\n</code></pre></p> <p>Pure iron sphere (single-composition, core fills entire planet): <pre><code>[AssumptionsAndInitialGuesses]\ncore_mass_fraction   = 1.0\nmantle_mass_fraction = 0\n# ...\n\n[EOS]\ncore      = \"Analytic:iron\"\nmantle    = \"Analytic:iron\"\nice_layer = \"\"\n</code></pre> Both <code>core</code> and <code>mantle</code> must be set even for a single-composition model. The mantle EOS is still evaluated but occupies zero mass.</p>"},{"location":"configuration/#legacy-configuration-backward-compatibility","title":"Legacy configuration (backward compatibility)","text":"<p>The previous single-field <code>choice</code> syntax is still recognized and auto-expanded to the per-layer format:</p> Legacy <code>choice</code> value Expands to <code>\"Tabulated:iron/silicate\"</code> <code>core = \"Seager2007:iron\"</code>, <code>mantle = \"Seager2007:MgSiO3\"</code> <code>\"Tabulated:iron/Tdep_silicate\"</code> <code>core = \"Seager2007:iron\"</code>, <code>mantle = \"WolfBower2018:MgSiO3\"</code> <code>\"Tabulated:water\"</code> <code>core = \"Seager2007:iron\"</code>, <code>mantle = \"Seager2007:MgSiO3\"</code>, <code>ice_layer = \"Seager2007:H2O\"</code> <code>\"Analytic:Seager2007\"</code> Per-layer analytic EOS from <code>core_material</code>, <code>mantle_material</code>, <code>water_layer_material</code> fields <p>Example of the old format (still works but deprecated): <pre><code>[EOS]\nchoice = \"Tabulated:iron/silicate\"\n</code></pre></p> <p>Example of the old analytic format (still works but deprecated): <pre><code>[EOS]\nchoice               = \"Analytic:Seager2007\"\ncore_material        = \"iron\"\nmantle_material      = \"MgSiO3\"\nwater_layer_material = \"\"\n</code></pre></p> <p>New configurations should use the per-layer format. The legacy format may be removed in a future version.</p>"},{"location":"configuration/#calculations","title":"<code>Calculations</code>","text":"<p>Numerical grid settings.</p> Parameter Type Unit Description <code>num_layers</code> int -- Number of radial grid points. Higher values increase resolution and accuracy at the cost of computation time. Default: 150."},{"location":"configuration/#iterativeprocess","title":"<code>IterativeProcess</code>","text":"<p>Controls the three nested iteration loops (outer mass convergence, inner density convergence, Brent pressure solver) and the ODE solver tolerances.</p> Parameter Type Unit Default Description <code>max_iterations_outer</code> int -- 100 Maximum iterations for the outer loop (total mass convergence). <code>tolerance_outer</code> float -- 3e-3 Relative tolerance for outer loop convergence (\\(\\lvert M_\\mathrm{calc} - M_\\mathrm{target} \\rvert / M_\\mathrm{target}\\)). <code>max_iterations_inner</code> int -- 100 Maximum iterations for the inner loop (density profile convergence). <code>tolerance_inner</code> float -- 1e-4 Relative tolerance for inner loop density convergence. <code>relative_tolerance</code> float -- 1e-5 Relative tolerance for <code>solve_ivp</code> (ODE integrator). <code>absolute_tolerance</code> float -- 1e-6 Absolute tolerance for <code>solve_ivp</code>. <code>maximum_step</code> float m 250000 Maximum radial step size for <code>solve_ivp</code>. <code>adaptive_radial_fraction</code> float -- 0.98 Fraction (0--1) of the radial domain where <code>solve_ivp</code> uses adaptive stepping before switching to fixed steps. Primarily relevant for the <code>WolfBower2018:MgSiO3</code> EOS near the surface. <code>max_center_pressure_guess</code> float Pa 10e12 Upper bound on the Brent solver's pressure bracket (\\(P_{\\mathrm{high}}\\)). This caps the central pressure (at the center of the iron core, which uses the Seager2007 EOS valid to \\(10^{16}\\) Pa), not the mantle pressure directly. The default of 10 TPa is intentionally higher than the WolfBower2018 table ceiling (~1 TPa) because it limits the core center, not the mantle. However, higher central pressures produce higher mantle pressures at the CMB, so capping \\(P_c\\) indirectly prevents deep-mantle pressures from exceeding the WB2018 table by too much. Only active when <code>WolfBower2018:MgSiO3</code> is used; not needed for pure-Seager runs."},{"location":"configuration/#guidance-on-reasonable-parameter-ranges","title":"Guidance on reasonable parameter ranges","text":"<p>The default values work well for Earth-mass planets with the default EOS. For other configurations:</p> <ul> <li>Super-Earths (1--10 \\(M_\\oplus\\)): The defaults generally suffice. For masses above ~5 \\(M_\\oplus\\), consider tightening <code>tolerance_outer</code> to 1e-4 and increasing <code>num_layers</code> to 200--300. The Brent pressure solver converges in 20--36 evaluations regardless of planet mass.</li> <li>Sub-Earths (&lt; 1 \\(M_\\oplus\\)): May converge faster. Defaults are conservative.</li> <li>Temperature-dependent EOS (<code>WolfBower2018:MgSiO3</code>): Limited to \\(\\leq 7\\,M_\\oplus\\). If convergence is slow, try reducing <code>maximum_step</code> (e.g., to 100000 m) and ensuring <code>adaptive_radial_fraction</code> is close to 1.0 (e.g., 0.98--0.99). The <code>max_center_pressure_guess</code> caps the Brent solver's upper bracket to prevent deep-mantle pressures from exceeding the WolfBower2018 table by too much. The default (10 TPa) is sufficient for planets up to 7 \\(M_\\oplus\\).</li> <li>Extended T-dependent EOS (<code>RTPress100TPa:MgSiO3</code>): Limited to \\(\\leq 50\\,M_\\oplus\\). The melt table extends to 100 TPa so <code>max_center_pressure_guess</code> capping is not applied. For very massive planets (&gt;10 \\(M_\\oplus\\)), consider increasing <code>num_layers</code> to 200--300 and tightening <code>tolerance_outer</code>.</li> <li>Analytic EOS: Convergence is typically fast and robust. Looser tolerances and fewer layers are usually sufficient for exploration.</li> <li>3-layer models: Adding an ice layer increases the number of density discontinuities. Consider increasing <code>num_layers</code> to 200+ for smooth profiles.</li> </ul>"},{"location":"configuration/#pressureadjustment","title":"<code>PressureAdjustment</code>","text":"<p>Controls the Brent root-finding solver that determines the central pressure. The solver finds \\(P_c\\) such that the surface pressure after ODE integration matches the target. See the model documentation for details on the algorithm.</p> Parameter Type Unit Default Description <code>target_surface_pressure</code> float Pa 101325 Target pressure at the planetary surface. Default is 1 atm. <code>pressure_tolerance</code> float Pa 1e9 Convergence criterion: the solver iterates until \\(\\lvert P_\\mathrm{surface} - P_\\mathrm{target} \\rvert\\) falls below this value. <code>max_iterations_pressure</code> int -- 200 Maximum number of function evaluations for the Brent solver. Typical convergence requires 20--36 evaluations. <code>pressure_adjustment_factor</code> float -- 1.1 Deprecated. Retained for backward compatibility. The Brent solver does not use this parameter."},{"location":"configuration/#output","title":"<code>Output</code>","text":"<p>Controls what the model writes after a run.</p> Parameter Type Default Description <code>data_enabled</code> bool true Write the computed radial profiles (radius, density, gravity, pressure, temperature, enclosed mass) to a text file in <code>output_files/</code>. <code>plots_enabled</code> bool false Generate profile plots after the run. <code>verbose</code> bool false Log detailed convergence diagnostics and warnings. When false, only essential messages (final results, errors) are shown. <code>iteration_profiles_enabled</code> bool false Write pressure and density profiles for every iteration to files. Useful for debugging convergence behavior; produces large output."},{"location":"data/","title":"Reference Data","text":""},{"location":"data/#download-instructions","title":"Download instructions","text":"<p>All tabulated data files are downloaded automatically by running the setup script from the repository root:</p> <pre><code>bash src/get_zalmoxis.sh\n</code></pre> <p>This invokes <code>src/setup_zalmoxis.py</code>, which downloads and extracts the required data into the <code>data/</code> directory. See Installation Step 4 of the installation guide for details.</p>"},{"location":"data/#data-inventory","title":"Data inventory","text":"<p>The table below lists every data file used by Zalmoxis, organised by subdirectory.</p>"},{"location":"data/#equation-of-state-tables","title":"Equation of state tables","text":"File Location Format Source Description <code>eos_seager07_iron.txt</code> <code>data/EOS_Seager2007/</code> CSV (rho in g/cm^3, P in GPa) Seager et al. (2007) Fe epsilon pressure-density EOS <code>eos_seager07_silicate.txt</code> <code>data/EOS_Seager2007/</code> CSV (rho in g/cm^3, P in GPa) Seager et al. (2007) MgSiO3 perovskite pressure-density EOS <code>eos_seager07_water.txt</code> <code>data/EOS_Seager2007/</code> CSV (rho in g/cm^3, P in GPa) Seager et al. (2007) Water ice VII pressure-density EOS <code>density_melt.dat</code> <code>data/EOS_WolfBower2018_1TPa/</code> TSV (P in Pa, T in K, rho in kg/m^3) Wolf &amp; Bower (2018) MgSiO3 melt density EOS (P: 0--1 TPa, T: 0--16500 K). Out-of-bounds pressures are clamped to the table edge. <code>density_solid.dat</code> <code>data/EOS_WolfBower2018_1TPa/</code> TSV (P in Pa, T in K, rho in kg/m^3) Wolf &amp; Bower (2018) MgSiO3 solid (bridgmanite) density EOS, derived from Mosenfelder et al. (2009) (P: 0--1 TPa, T: 0--16500 K). Out-of-bounds pressures are clamped to the table edge. <code>density_melt.dat</code> <code>data/EOS_RTPress_melt_100TPa/</code> TSV (P in Pa, T in K, rho in kg/m^3) Extended RTpress melt table MgSiO3 melt density EOS extended to 100 TPa (P: 1e3--1e14 Pa, T: 400--50000 K). Used by <code>RTPress100TPa:MgSiO3</code>. Solid phase uses the WolfBower2018 table above."},{"location":"data/#melting-curves","title":"Melting curves","text":"File Location Format Source Description <code>solidus.dat</code> <code>data/melting_curves_Monteux-600/</code> Space-separated (P in Pa, T in K) Monteux et al. (2016) MgSiO3 solidus curve (offset: solidus = liquidus \u2212 600 K) <code>liquidus.dat</code> <code>data/melting_curves_Monteux-600/</code> Space-separated (P in Pa, T in K) Monteux et al. (2016) MgSiO3 liquidus curve"},{"location":"data/#mass-radius-curves","title":"Mass-radius curves","text":"File Location Format Source Description <code>massradiusEarthlikeRocky.txt</code> <code>data/mass_radius_curves/</code> Space-separated (M in M_Earth, R in R_Earth) Zeng et al. (2019) Earth-like rocky M-R curve (32.5% Fe + 67.5% MgSiO3) <code>massradius_50percentH2O_300K_1mbar.txt</code> <code>data/mass_radius_curves/</code> Space-separated (M in M_Earth, R in R_Earth) Zeng et al. (2019) 50% H2O + 50% rocky M-R curve (300 K, 1 mbar surface)"},{"location":"data/#radial-profiles-validation-benchmarks","title":"Radial profiles (validation benchmarks)","text":"File Location Format Source Description <code>radiusdensitySeagerEarth.txt</code> <code>data/radial_profiles/</code> CSV (r, rho) Seager et al. (2007) Earth-like radial density profile <code>radiusdensitySeagerEarthbymass.txt</code> <code>data/radial_profiles/</code> CSV (M, r, rho) Seager et al. (2007) Earth-like radial density profile (indexed by enclosed mass) <code>radiusdensitySeagerwater.txt</code> <code>data/radial_profiles/</code> CSV (r, rho) Seager et al. (2007) Water-world radial density profile <code>radiusdensitySeagerwaterbymass.txt</code> <code>data/radial_profiles/</code> CSV (M, r, rho) Seager et al. (2007) Water-world radial density profile (indexed by enclosed mass) <code>radiusdensityEarthBoujibar.txt</code> <code>data/radial_profiles/</code> CSV (r, rho) Boujibar et al. (2020) Earth radial density profile <code>radiuspressureEarthBoujibar.txt</code> <code>data/radial_profiles/</code> CSV (r, P) Boujibar et al. (2020) Earth radial pressure profile <code>radiusdensityWagner.txt</code> <code>data/radial_profiles/</code> CSV (r, rho) Wagner et al. (2011) Earth radial density profile <code>radiuspressureWagner.txt</code> <code>data/radial_profiles/</code> CSV (r, P) Wagner et al. (2011) Earth radial pressure profile <code>radiusgravityWagner.txt</code> <code>data/radial_profiles/</code> CSV (r, g) Wagner et al. (2011) Earth radial gravity profile"},{"location":"data/#seager-eos-data","title":"Seager EOS data","text":"<p>Zalmoxis uses the tabulated equation of state (EOS) data from Seager et al. (2007), providing pressure-density relations for iron (Fe epsilon), silicate (MgSiO3 perovskite), and water ice (ice VII). These tables are automatically downloaded during the setup process described above.</p>"},{"location":"data/#analytic-eos","title":"Analytic EOS","text":"<p>The <code>Analytic:&lt;material&gt;</code> EOS options (e.g. <code>Analytic:iron</code>, <code>Analytic:MgSiO3</code>, <code>Analytic:H2O</code>) use the analytic modified polytropic fits from Table 3 of Seager et al. (2007). All fit parameters are hardcoded directly from the paper and do not require any data downloads. This makes the analytic EOS suitable for quick setup, CI environments, or situations where the tabulated data files are not available.</p> <p>Any EOS name beginning with <code>Analytic:</code> is self-contained. The analytic EOS additionally provides three materials (MgFeSiO3, graphite, SiC) that are not available in the tabulated data.</p>"},{"location":"data/#mass-radius-relations","title":"Mass-radius relations","text":"<p>The following curves serve as reference benchmarks for validating the Zalmoxis internal structure model under both rocky and water-rich configurations:</p> <ul> <li> <p>Earth-like rocky exoplanets, with a 32.5% Fe + 67.5% MgSiO3 composition, taken from Zeng et al. (2019).</p> </li> <li> <p>Water exoplanets, with a 50% Earth-like rocky core (32.5% Fe + 67.5% MgSiO3) and 50% water by mass at 300 K and surface pressure of 1 mbar.</p> </li> </ul>"},{"location":"installation/","title":"Installation","text":"<p>Installation within the PROTEUS framework</p> <p>The standard way of installing Zalmoxis is within the PROTEUS framework, as described in the PROTEUS installation guide. When installed as part of PROTEUS, Zalmoxis is set up automatically alongside all other modules. The standalone instructions below are only needed if you want to use Zalmoxis independently of PROTEUS.</p>"},{"location":"installation/#prerequisites","title":"Prerequisites","text":"<ul> <li>Operating system: macOS (Intel or Apple Silicon) or Linux (Windows is not supported)</li> <li>Python: 3.12 (recommended; matches the PROTEUS framework requirement)</li> <li>Conda: miniforge (macOS) or miniconda (Linux) for environment management</li> <li>Git: for cloning the repository</li> <li>Disk space: approximately 500 MB for tabulated EOS data files</li> </ul>"},{"location":"installation/#installation-steps","title":"Installation steps","text":""},{"location":"installation/#step-1-create-and-activate-a-conda-environment","title":"Step 1: Create and activate a conda environment","text":"<pre><code>conda create -n zalmoxis python=3.12\nconda activate zalmoxis\n</code></pre> <p>If you are already working inside a PROTEUS conda environment (<code>conda activate proteus</code>), you can skip this step and install Zalmoxis into that environment directly.</p>"},{"location":"installation/#step-2-clone-the-repository-and-install-dependencies","title":"Step 2: Clone the repository and install dependencies","text":"<pre><code>git clone https://github.com/FormingWorlds/Zalmoxis.git\ncd Zalmoxis\npip install -e .\n</code></pre> <p>This installs Zalmoxis in editable mode, so local changes to the code are immediately reflected.</p> <p>For development (includes pytest, pytest-xdist, ruff, coverage, and pre-commit):</p> <pre><code>pip install -e \".[develop]\"\n</code></pre> <p>The <code>[develop]</code> extras are required for running the test suite. See the Testing page for details.</p>"},{"location":"installation/#step-3-set-the-environment-variable","title":"Step 3: Set the environment variable","text":"<p>Zalmoxis requires the <code>ZALMOXIS_ROOT</code> environment variable to point to the base directory:</p> <pre><code>export ZALMOXIS_ROOT=$(pwd)\n</code></pre> <p>To make <code>ZALMOXIS_ROOT</code> available across sessions, add the above line to your shell profile file:</p> <ul> <li>For <code>bash</code> users:</li> </ul> <pre><code>echo \"export ZALMOXIS_ROOT=$(pwd)\" &gt;&gt; ~/.bashrc\nsource ~/.bashrc\n</code></pre> <ul> <li>For <code>zsh</code> users:</li> </ul> <pre><code>echo \"export ZALMOXIS_ROOT=$(pwd)\" &gt;&gt; ~/.zshrc\nsource ~/.zshrc\n</code></pre>"},{"location":"installation/#step-4-download-eos-data","title":"Step 4: Download EOS data","text":"<p>Run the provided script to download the required equation-of-state tables and reference data:</p> <pre><code>bash src/get_zalmoxis.sh\n</code></pre> <p>This downloads data into the <code>data/</code> directory within the Zalmoxis repository (not into <code>FWL_DATA</code>). When Zalmoxis is installed within PROTEUS, the data path is managed by the PROTEUS framework. The script also creates the <code>output_files/</code> folder for model results.</p>"},{"location":"installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"installation/#zalmoxis_root-not-set","title":"<code>ZALMOXIS_ROOT</code> not set","text":"<pre><code>RuntimeError: ZALMOXIS_ROOT environment variable not set\n</code></pre> <p>This error occurs when the <code>ZALMOXIS_ROOT</code> environment variable is not defined in your current shell session. Set it to the root of the Zalmoxis repository:</p> <pre><code>export ZALMOXIS_ROOT=/path/to/Zalmoxis\n</code></pre> <p>If you added the variable to your shell profile (Step 3) but still see the error, reload your profile (<code>source ~/.bashrc</code> or <code>source ~/.zshrc</code>) or open a new terminal session.</p>"},{"location":"installation/#data-files-missing","title":"Data files missing","text":"<pre><code>FileNotFoundError: [Errno 2] No such file or directory: '.../data/EOS_Seager2007/...'\n</code></pre> <p>This error indicates that the tabulated EOS data files have not been downloaded. Run <code>bash src/get_zalmoxis.sh</code> from the Zalmoxis root directory to complete Step 4.</p>"},{"location":"installation/#import-errors","title":"Import errors","text":"<pre><code>ModuleNotFoundError: No module named 'zalmoxis'\n</code></pre> <p>Verify that you are running Python from the conda environment where Zalmoxis was installed:</p> <pre><code>conda activate zalmoxis\nwhich python  # should point to your conda env\n</code></pre> <p>If you installed Zalmoxis into the PROTEUS environment, activate that instead:</p> <pre><code>conda activate proteus\n</code></pre>"},{"location":"installation/#convergence-failures","title":"Convergence failures","text":"<p>The Brent pressure solver is robust and typically converges in 20--36 evaluations. If the solver fails to converge, consider the following:</p> <ul> <li>Bracket error (<code>ValueError: f(a) and f(b) must have different signs</code>): The initial pressure bracket does not straddle the root. This usually means the true central pressure is outside the bracket range. Try increasing <code>max_center_pressure_guess</code> (for WolfBower2018 EOS) or check that the planet mass and composition are physically plausible.</li> <li>WolfBower2018 mass limit: The <code>WolfBower2018:MgSiO3</code> EOS is limited to \\(\\leq 7\\,M_\\oplus\\). For higher-mass planets, use <code>Seager2007:MgSiO3</code> or <code>Analytic:MgSiO3</code> instead.</li> <li>Tolerance parameters: Relax the convergence tolerance in the input configuration file. Tighter tolerances require more iterations and may not converge for extreme planetary compositions or masses.</li> <li>Physical plausibility: Verify that the input parameters (mass, composition fractions, core/mantle fractions) are physically plausible. Unphysical configurations (e.g., negative mass fractions, zero-thickness layers) will not converge.</li> </ul>"},{"location":"model/","title":"Interior Structure Model","text":"<p>Zalmoxis solves the coupled ordinary differential equations (ODEs) of hydrostatic equilibrium for a differentiated planet with 2--3 compositionally distinct layers (iron core, silicate mantle, and optional water/ice envelope). Given a total planet mass, layer mass fractions, and a per-layer equation of state (EOS) specification, the code iteratively determines self-consistent radial profiles of pressure, density, gravity, and enclosed mass from the center to the surface. Three families of EOS are supported and can be mixed arbitrarily across layers: the Seager et al. (2007) merged tabulated EOS at 300 K, the temperature-dependent Wolf &amp; Bower (2018) RTpress EOS with phase-aware melt fractions, and a fast analytic modified-polytrope approximation from Seager et al. (2007).</p>"},{"location":"model/#governing-equations","title":"Governing Equations","text":"<p>The internal structure model assumes hydrostatic and thermodynamic equilibrium within each layer. Starting from the center and integrating outward, the code solves the following coupled ODEs using <code>scipy.integrate.solve_ivp</code> (explicit Runge--Kutta, RK45):</p> \\[ \\frac{dM}{dr} = 4 \\pi r^2 \\rho \\] \\[ \\frac{dg}{dr} = 4 \\pi G \\rho - \\frac{2g}{r} \\] \\[ \\frac{dP}{dr} = -\\rho \\, g \\] <p>where \\(M(r)\\) is the enclosed mass within radius \\(r\\), \\(\\rho(r)\\) is the local density, \\(g(r)\\) is the gravitational acceleration, \\(P(r)\\) is the pressure, and \\(G\\) is the gravitational constant.</p> <p>The density \\(\\rho(P)\\) --- or \\(\\rho(P, T)\\) when a temperature-dependent EOS is used --- closes the system at each radial shell.</p>"},{"location":"model/#per-layer-eos-architecture","title":"Per-Layer EOS Architecture","text":""},{"location":"model/#configuration-format","title":"Configuration format","text":"<p>Each structural layer is assigned its own EOS via a string of the form <code>\"&lt;source&gt;:&lt;composition&gt;\"</code> in the <code>[EOS]</code> section of the TOML configuration file:</p> <pre><code>[EOS]\ncore      = \"Seager2007:iron\"\nmantle    = \"WolfBower2018:MgSiO3\"\nice_layer = \"\"   # empty = 2-layer model\n</code></pre> <p>Layer boundaries are determined by cumulative mass fractions: a radial shell belongs to the core when \\(M(r) &lt; M_{\\mathrm{core}}\\), to the mantle when \\(M_{\\mathrm{core}} \\le M(r) &lt; M_{\\mathrm{core}} + M_{\\mathrm{mantle}}\\), and to the outer ice layer (if present) otherwise. The function <code>get_layer_eos()</code> in <code>structure_model.py</code> maps the enclosed mass at each integration step to the appropriate per-layer EOS string, which is then dispatched to <code>calculate_density()</code>.</p> <p>This architecture replaced an earlier design that used a single global <code>EOS_CHOICE</code> string (e.g., <code>\"Tabulated:iron/silicate\"</code>) to select a fixed combination of materials for the entire planet. The per-layer system allows arbitrary mixing of tabulated and analytic EOS across layers --- for instance, an analytic iron core with a temperature-dependent silicate mantle --- without modifying the solver.</p> <p>Legacy global strings are still accepted via a backward-compatible mapping in <code>parse_eos_config()</code>.</p>"},{"location":"model/#valid-per-layer-eos-identifiers","title":"Valid per-layer EOS identifiers","text":"Identifier Source Material Temperature <code>Seager2007:iron</code> Tabulated Fe (\\(\\epsilon\\)) 300 K <code>Seager2007:MgSiO3</code> Tabulated MgSiO\\(_3\\) perovskite 300 K <code>Seager2007:H2O</code> Tabulated Water ice (VII/VIII/X) 300 K <code>WolfBower2018:MgSiO3</code> Tabulated MgSiO\\(_3\\) (solid + melt) \\(T\\)-dependent (\\(\\leq 7\\,M_\\oplus\\)) <code>RTPress100TPa:MgSiO3</code> Tabulated MgSiO\\(_3\\) (solid + melt) \\(T\\)-dependent (\\(\\leq 50\\,M_\\oplus\\)) <code>Analytic:&lt;material&gt;</code> Analytic fit Any of 6 materials 300 K"},{"location":"model/#eos-physics","title":"EOS Physics","text":""},{"location":"model/#seager-et-al-2007-tabulated-eos","title":"Seager et al. (2007) Tabulated EOS","text":"<p>The tabulated EOS from Seager et al. (2007) provides \\(\\rho(P)\\) at 300 K for iron (Fe \\(\\epsilon\\)-phase), MgSiO\\(_3\\) perovskite, and water ice. The tables are constructed by merging two regimes:</p> <ul> <li>Low pressure (\\(P \\lesssim 200\\) GPa): Vinet EOS for iron, fourth-order Birch--Murnaghan EOS for MgSiO\\(_3\\) and water ice, fitted to experimental data and DFT calculations.</li> <li>High pressure (\\(P \\gtrsim 10^4\\) GPa): Thomas--Fermi--Dirac (TFD) theory, which becomes exact in the limit of fully ionized, degenerate electron gas.</li> </ul> <p>The two regimes are smoothly joined in the intermediate range.</p> <p>Limitations. The tabulated EOS is evaluated at a fixed temperature of 300 K and does not account for thermal pressure, phase transitions (e.g., post-perovskite), compositional gradients, or partial melting. It is appropriate for cold, fully solidified structure models.</p>"},{"location":"model/#wolf-bower-2018-temperature-dependent-eos","title":"Wolf &amp; Bower (2018) Temperature-Dependent EOS","text":"<p>The <code>WolfBower2018:MgSiO3</code> EOS implements the RTpress (Reciprocal Transform pressure) framework from Wolf &amp; Bower (2018), providing \\(\\rho(P, T)\\) for MgSiO\\(_3\\) in both the solid and liquid phases. The solid-phase EOS is derived from Mosenfelder et al. (2009). This EOS captures the thermal expansivity and compressibility of silicate mantle material over a wide \\(P\\)--\\(T\\) range.</p> <p>Phase boundaries are defined using solidus and liquidus melting curves derived from Monteux et al. (2016), with the solidus offset by \\(-600\\) K from the liquidus. At each radial shell, the code evaluates the local melt fraction:</p> \\[ f_{\\mathrm{melt}} = \\frac{T - T_{\\mathrm{sol}}}{T_{\\mathrm{liq}} - T_{\\mathrm{sol}}} \\] <p>where \\(T\\) is the local temperature, \\(T_{\\mathrm{sol}}\\) is the solidus temperature, and \\(T_{\\mathrm{liq}}\\) is the liquidus temperature at the local pressure. Three phase regimes are distinguished:</p> <ul> <li>Solid (\\(T \\le T_{\\mathrm{sol}}\\), \\(f_{\\mathrm{melt}} \\le 0\\)): density from the solid-state EOS table.</li> <li>Melt (\\(T \\ge T_{\\mathrm{liq}}\\), \\(f_{\\mathrm{melt}} \\ge 1\\)): density from the liquid-state EOS table.</li> <li>Mixed / mush (\\(T_{\\mathrm{sol}} &lt; T &lt; T_{\\mathrm{liq}}\\)): density from volume-additive interpolation between solid and liquid densities:</li> </ul> \\[ \\rho_{\\mathrm{mixed}} = \\left[ (1 - f_{\\mathrm{melt}}) \\, \\rho_{\\mathrm{solid}}^{-1} + f_{\\mathrm{melt}} \\, \\rho_{\\mathrm{liquid}}^{-1} \\right]^{-1} \\] <p>This EOS is appropriate when modeling hot rocky planets whose mantles may be partially or fully molten, which is critical for accurately coupling to thermal evolution codes. A temperature profile (isothermal, linear, or prescribed from file) must be supplied. When this EOS is selected for any layer, the radial integration is split into two segments (controlled by <code>adaptive_radial_fraction</code>) to handle the steep density gradients near the surface.</p> <p>Mass limit. The WolfBower2018 tables cover pressures up to ~1 TPa. For planets above ~2 \\(M_\\oplus\\), deep-mantle pressures near the core-mantle boundary begin to exceed this table ceiling. The Brent pressure solver (see Pressure Solver) with out-of-bounds pressure clamping handles this gracefully up to \\(7\\,M_\\oplus\\): pressures beyond the table boundary are clamped to the table edge, returning the boundary density. This approximation is acceptable for planets up to ~7 \\(M_\\oplus\\), where the clamped region is a small fraction of the mantle. Beyond \\(7\\,M_\\oplus\\), the clamped densities diverge too far from reality and the code raises a <code>ValueError</code>. For higher-mass planets, use <code>RTPress100TPa:MgSiO3</code> (T-dependent, up to ~50 \\(M_\\oplus\\)) or <code>Seager2007:MgSiO3</code> / <code>Analytic:MgSiO3</code> (300 K, up to ~50 \\(M_\\oplus\\)).</p>"},{"location":"model/#rtpress100tpa-extended-melt-eos","title":"RTPress100TPa Extended Melt EOS","text":"<p>The <code>RTPress100TPa:MgSiO3</code> EOS extends the melt phase coverage from the WolfBower2018 1 TPa ceiling to 100 TPa (\\(P\\): \\(10^3\\)--\\(10^{14}\\) Pa, \\(T\\): 400--50000 K). This enables temperature-dependent modeling of much more massive rocky planets (up to ~50 \\(M_\\oplus\\)).</p> <p>The solid-phase EOS remains the Wolf &amp; Bower (2018) / Mosenfelder et al. (2009) table (valid to 1 TPa, clamped at boundary). At the high internal temperatures typical of massive rocky planets, the mantle is predominantly molten, so the solid table limitation is less constraining than it would be for cooler planets. The same Monteux et al. (2016) solidus/liquidus melting curves are used for phase determination.</p> <p>Mass limit. The melt table extends to 100 TPa, matching the Seager2007 iron EOS range. The solid table is clamped at 1 TPa, but this primarily affects cold planets where a significant fraction of the mantle is solid. The code allows planets up to 50 \\(M_\\oplus\\) with this EOS. Unlike <code>WolfBower2018:MgSiO3</code>, the central pressure is not capped by <code>max_center_pressure_guess</code> since the melt table covers the full range.</p>"},{"location":"model/#analytic-modified-polytrope-seager-et-al-2007","title":"Analytic Modified Polytrope (Seager et al. 2007)","text":"<p>The analytic EOS implements the modified polytropic fit from Seager et al. (2007), Table 3, Eq. 11:</p> \\[ \\rho(P) = \\rho_0 + c \\cdot P^n \\] <p>where \\(\\rho\\) is density in kg/m\\(^3\\), \\(P\\) is pressure in Pa, and \\(\\rho_0\\), \\(c\\), \\(n\\) are material-specific parameters. This closed-form expression approximates the full merged Vinet/BME + TFD EOS without requiring tabulated data files.</p> <p>Accuracy is 2--5% at low (\\(P &lt; 5\\) GPa) and high (\\(P &gt; 30\\) TPa) pressures, and degrades to up to 12% at intermediate pressures where the transition between the low-pressure and TFD regimes occurs. The fit is valid for \\(P &lt; 10^{16}\\) Pa.</p> <p>Six materials are available:</p> Material key Compound \\(\\rho_0\\) (kg/m\\(^3\\)) \\(c\\) (kg m\\(^{-3}\\) Pa\\(^{-n}\\)) \\(n\\) <code>iron</code> Fe (\\(\\epsilon\\)) 8300 0.00349 0.528 <code>MgSiO3</code> MgSiO\\(_3\\) perovskite 4100 0.00161 0.541 <code>MgFeSiO3</code> (Mg,Fe)SiO\\(_3\\) 4260 0.00127 0.549 <code>H2O</code> Water ice (VII/VIII/X) 1460 0.00311 0.513 <code>graphite</code> C (graphite) 2250 0.00350 0.514 <code>SiC</code> Silicon carbide 3220 0.00172 0.537 <p>Like the Seager et al. (2007) tabulated EOS, this assumes 300 K and no phase transitions. Because any of the six materials can be assigned to any structural layer, the analytic EOS enables modeling of exotic compositions (e.g., carbon planets with iron/SiC or iron/graphite layers) that are not available in the tabulated data.</p>"},{"location":"model/#validity-ranges","title":"Validity Ranges","text":""},{"location":"model/#by-eos-type","title":"By EOS type","text":"EOS Pressure range Temperature Max planet mass Notes <code>Seager2007:iron</code> 0--\\(10^{16}\\) Pa 300 K (fixed) ~50 \\(M_\\oplus\\) Vinet + DFT + TFD <code>Seager2007:MgSiO3</code> 0--\\(10^{16}\\) Pa 300 K (fixed) ~50 \\(M_\\oplus\\) 4th-order BME + DFT + TFD <code>Seager2007:H2O</code> 0--\\(10^{16}\\) Pa 300 K (fixed) ~50 \\(M_\\oplus\\) Experimental + DFT + TFD <code>WolfBower2018:MgSiO3</code> 0--\\(10^{12}\\) Pa (1 TPa) 0--16500 K 7 \\(M_\\oplus\\) RTpress; \\(P\\) clamped at table edge, \\(T\\) out-of-bounds raises error <code>RTPress100TPa:MgSiO3</code> \\(10^3\\)--\\(10^{14}\\) Pa (100 TPa) 400--50000 K 50 \\(M_\\oplus\\) Extended melt table; solid from WB2018 (clamped at 1 TPa) <code>Analytic:*</code> 0--\\(10^{16}\\) Pa 300 K (fixed) ~50 \\(M_\\oplus\\) 2--12% accuracy vs. tabulated"},{"location":"model/#general-limits","title":"General limits","text":"<ul> <li>Mass range: The model is designed for rocky and water-rich planets in the range \\(\\sim 0.1\\)--\\(50 \\, M_{\\oplus}\\).   Below \\(\\sim 0.1 \\, M_{\\oplus}\\), the assumption of hydrostatic equilibrium and the EOS parameterizations become unreliable.   Above \\(\\sim 50 \\, M_{\\oplus}\\), the planet enters the gas-giant regime where the absence of an H/He envelope EOS limits applicability.</li> <li>Pressure range: The Seager et al. (2007) tabulated and analytic EOS are valid up to \\(P \\sim 10^{16}\\) Pa (\\(10^{10}\\) GPa), which exceeds central pressures for all planets within the supported mass range.   The WolfBower2018 tables are limited to ~1 TPa; out-of-bounds pressures are clamped to the table edge (see EOS Physics &gt; Wolf &amp; Bower 2018).</li> <li>Temperature range (Wolf &amp; Bower 2018 only): The \\(P\\)--\\(T\\) tables cover 0--16500 K; the code raises a <code>ValueError</code> if the requested temperature falls outside this grid.   Out-of-bounds pressures are clamped to the table edge (see above), but out-of-bounds temperatures are not.   The Seager et al. (2007) EOS (both tabulated and analytic) is evaluated at a fixed 300 K and carries no temperature dependence.</li> <li>Composition: All EOS assume single-component layers with sharp compositional boundaries (no mixing gradients across interfaces).</li> </ul>"},{"location":"model/#process-flow","title":"Process Flow","text":""},{"location":"model/#configuration-loading","title":"Configuration Loading","text":"<p>The function <code>load_zalmoxis_config()</code> reads a TOML configuration file that specifies planet mass, layer mass fractions, per-layer EOS identifiers, temperature profile settings, solver tolerances, and output options. The <code>[EOS]</code> section is parsed by <code>parse_eos_config()</code>, which accepts both the new per-layer format and the legacy global-string format.</p>"},{"location":"model/#initial-parameter-setup","title":"Initial Parameter Setup","text":"<p>The initial guess for the planet radius follows the scaling law from Noack et al. (2020):</p> \\[ R_p \\; [\\mathrm{m}] = 1000 \\times (7030 - 1840 \\times X_{\\mathrm{CMF}}) \\times \\left( \\frac{M_p}{M_{\\oplus}} \\right)^{0.282} \\] <p>where \\(X_{\\mathrm{CMF}}\\) is the core mass fraction (<code>core_mass_fraction</code>), \\(M_p\\) is the planet mass, and \\(M_{\\oplus}\\) is Earth's mass. The original scaling law uses the planetary iron weight fraction; for a differentiated planet with a pure-iron core, this equals the core mass fraction.</p> <p>The initial guess for the core mass is:</p> \\[ M_{\\mathrm{core}} = X_{\\mathrm{CMF}} \\times M_p \\] <p>The initial guess for the central pressure is based on an empirical scaling:</p> \\[ P_c = P_{c,\\oplus} \\times \\left( \\frac{M_p}{M_{\\oplus}} \\right)^{2} \\times \\left( \\frac{R_p}{R_{\\oplus}} \\right)^{-4} \\] <p>where \\(P_{c,\\oplus}\\) is Earth's central pressure and \\(R_{\\oplus}\\) is Earth's radius.</p>"},{"location":"model/#iterative-solution","title":"Iterative Solution","text":"<p>The model uses three nested convergence loops:</p> <ol> <li> <p>Outer loop (mass convergence): Updates the total planet radius estimate by comparing the calculated total mass against the target mass and rescaling: \\(R_p \\leftarrow R_p \\times (M_{\\mathrm{target}} / M_{\\mathrm{calculated}})^{1/3}\\).</p> </li> <li> <p>Inner loop (density profile convergence): For each radial shell, recalculates the density from the local pressure (and temperature, if applicable) using the per-layer EOS returned by <code>get_layer_eos()</code>.    Density updates are damped by averaging with the previous iteration.</p> </li> <li> <p>Pressure solver (Brent's method): Finds the central pressure \\(P_c\\) such that the surface pressure matches the target boundary condition. See Pressure Solver below.</p> </li> </ol>"},{"location":"model/#pressure-solver-brents-method","title":"Pressure Solver (Brent's Method)","text":"<p>The central pressure \\(P_c\\) is determined by solving a 1D root-finding problem: find \\(P_c\\) such that the residual</p> \\[ f(P_c) = P_{\\mathrm{surface}}(P_c) - P_{\\mathrm{target}} \\] <p>is zero, where \\(P_{\\mathrm{surface}}(P_c)\\) is the surface pressure obtained by integrating the coupled ODEs from the center outward with initial condition \\(P(r=0) = P_c\\).</p> <p>Zalmoxis uses Brent's method (<code>scipy.optimize.brentq</code>) for this root-finding step. Brent's method combines bisection, secant, and inverse quadratic interpolation: it maintains a valid bracket (like bisection, guaranteeing convergence) while accelerating with superlinear methods when possible. This provides both robustness and speed, typically converging in 20--36 function evaluations.</p> <p>Bracket construction. The initial bracket \\([P_{\\mathrm{low}}, P_{\\mathrm{high}}]\\) is constructed around an empirical scaling-law estimate \\(\\hat{P}_c\\):</p> \\[ \\hat{P}_c = P_{c,\\oplus} \\times \\left( \\frac{M_p}{M_{\\oplus}} \\right)^{2} \\times \\left( \\frac{R_p}{R_{\\oplus}} \\right)^{-4} \\] <p>with \\(P_{\\mathrm{low}} = \\max(10^6 \\, \\mathrm{Pa}, \\; 0.1 \\, \\hat{P}_c)\\) and \\(P_{\\mathrm{high}} = 10 \\, \\hat{P}_c\\). When using <code>WolfBower2018:MgSiO3</code>, \\(P_{\\mathrm{high}}\\) is further capped at <code>max_center_pressure_guess</code> to prevent excessively high central pressures that would push deep-mantle pressures far beyond the 1 TPa WolfBower2018 table ceiling.</p> <p>Terminal event. Each ODE integration includes a terminal event that stops <code>solve_ivp</code> when the pressure crosses zero (\\(P \\to 0^-\\)). Without this event, trial central pressures far below the true value cause the integrator to grind with vanishingly small step sizes in the zero-derivative region (where <code>coupled_odes()</code> returns \\([0, 0, 0]\\) for non-physical pressure). The terminal event reduces evaluation time for bad guesses from minutes to milliseconds.</p> <p>Early termination handling. When the terminal event fires, the ODE integration stops short of the planet surface and the solution arrays are padded with zeros. The residual function detects this (\\(P_{\\mathrm{surface}} \\leq 0\\)) and returns \\(-P_{\\mathrm{target}}\\) --- a negative value that signals to Brent's method that \\(P_c\\) is too low, maintaining a valid bracket.</p> <p>Closure state capture. Since <code>brentq</code> only returns the root value (not intermediate ODE solutions), the residual function uses a mutable closure dict to capture the mass, gravity, and pressure arrays from the last evaluation. After convergence, these arrays are extracted for the density update step.</p>"},{"location":"model/#convergence-checks","title":"Convergence Checks","text":"<ul> <li>The outer loop converges when the relative mass difference falls below <code>tolerance_outer</code>.</li> <li>The inner loop converges when the maximum relative density change across all shells falls below <code>tolerance_inner</code>.</li> <li>The pressure solver converges when (a) <code>brentq</code> reports convergence, (b) the surface pressure residual is within <code>pressure_tolerance</code> of the target, and (c) all pressures are non-negative (\\(P \\geq 0\\), allowing for zero-padded surface points from the terminal event).</li> </ul> <p>The model reports overall convergence only when all three loops have converged.</p>"},{"location":"model/#output","title":"Output","text":"<p>On convergence, the model returns radial profiles of gravity, pressure, density, temperature, and enclosed mass. Derived structural parameters include: core radius, CMB pressure, central pressure, average density, core mass fraction, core radius fraction, and (if applicable) mantle phase fractions.</p>"},{"location":"model/#code-architecture","title":"Code Architecture","text":""},{"location":"model/#module-overview","title":"Module overview","text":"<pre><code>src/zalmoxis/\n\u251c\u2500\u2500 zalmoxis.py          # Orchestration: config loading, iteration loops, Brent solver, output\n\u251c\u2500\u2500 structure_model.py   # ODE system: coupled_odes(), solve_structure(), terminal events\n\u251c\u2500\u2500 eos_functions.py     # EOS dispatch: calculate_density(), Tdep phase logic, temperature profiles\n\u251c\u2500\u2500 eos_analytic.py      # Analytic modified polytrope: get_analytic_density()\n\u251c\u2500\u2500 eos_properties.py    # Material property dictionaries (file paths, unit conversions)\n\u251c\u2500\u2500 constants.py         # Physical constants (G, earth_mass, earth_radius, etc.)\n\u2514\u2500\u2500 plots/               # Visualization (profile plots, P-T phase diagrams)\n</code></pre>"},{"location":"model/#data-flow","title":"Data flow","text":"<pre><code>TOML config\n    \u2502\n    \u25bc\nparse_eos_config() \u2500\u2500\u25ba layer_eos_config dict\n    \u2502                   {\"core\": \"Seager2007:iron\", \"mantle\": \"WolfBower2018:MgSiO3\"}\n    \u25bc\nmain() \u2500\u2500\u2500 outer loop (radius) \u2500\u2500\u2500 inner loop (density) \u2500\u2500\u2500 brentq(_pressure_residual)\n    \u2502                                                             \u2502\n    \u2502                                                             \u25bc\n    \u2502                                                     solve_structure()\n    \u2502                                                             \u2502\n    \u2502                                                             \u25bc\n    \u2502                                                     solve_ivp(coupled_odes)\n    \u2502                                                             \u2502\n    \u2502                                                             \u25bc\n    \u2502                                                     get_layer_eos() \u2192 calculate_density()\n    \u2502                                                             \u2502\n    \u2502                                                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502                                                      \u25bc      \u25bc      \u25bc\n    \u2502                                               Seager2007  Tdep    Analytic\n    \u2502                                              (tabulated) (WB2018/ (polytrope)\n    \u2502                                                          RTPress)\n    \u25bc\npost_processing() \u2500\u2500\u25ba output files + plots\n</code></pre>"},{"location":"model/#key-functions","title":"Key functions","text":"<ul> <li> <p><code>main()</code> (<code>zalmoxis.py</code>): Orchestrates the three nested convergence loops.   The innermost loop uses <code>scipy.optimize.brentq</code> to find the central pressure root (see Pressure Solver).</p> </li> <li> <p><code>_pressure_residual()</code> (<code>zalmoxis.py</code>, closure inside <code>main()</code>): Residual function \\(f(P_c) = P_{\\mathrm{surface}}(P_c) - P_{\\mathrm{target}}\\) passed to <code>brentq</code>.   Calls <code>solve_structure()</code> for each trial \\(P_c\\) and captures the ODE solution via a mutable closure dict.</p> </li> <li> <p><code>get_layer_eos()</code> (<code>structure_model.py</code>): Maps the enclosed mass at a given radial shell to the per-layer EOS string by comparing against core and core+mantle mass thresholds.   Purely geometric --- no EOS-type branching.</p> </li> <li> <p><code>coupled_odes()</code> (<code>structure_model.py</code>): Defines the derivatives \\(dM/dr\\), \\(dg/dr\\), \\(dP/dr\\) for the ODE solver.   Calls <code>calculate_density()</code> at each evaluation to close the system.   Returns \\([0, 0, 0]\\) for non-physical states (negative pressure, invalid density) to signal the adaptive solver to reject the step and retry smaller.</p> </li> <li> <p><code>solve_structure()</code> (<code>structure_model.py</code>): Integrates the coupled ODEs across the planetary radius using <code>scipy.integrate.solve_ivp</code> (RK45).   Includes a terminal event that stops integration when pressure crosses zero.   When any layer uses a temperature-dependent EOS (<code>WolfBower2018:MgSiO3</code> or <code>RTPress100TPa:MgSiO3</code>), the radial grid is split into two segments for numerical stability near the surface; otherwise, a single integration pass is performed.   Pads output arrays to <code>len(radii)</code> if the terminal event truncates the integration.</p> </li> <li> <p><code>calculate_density()</code> (<code>eos_functions.py</code>): Dispatches the per-layer EOS string to the appropriate density calculation: tabulated lookup for <code>Seager2007:*</code>, temperature-dependent phase-aware lookup for <code>WolfBower2018:MgSiO3</code> and <code>RTPress100TPa:MgSiO3</code>, or direct evaluation for <code>Analytic:*</code> strings.</p> </li> <li> <p><code>get_Tdep_density()</code> (<code>eos_functions.py</code>): Computes mantle density accounting for temperature-dependent phase transitions using the solidus/liquidus melting curves and volume-additive mixing in the mush regime.   Guards against <code>None</code> returns from out-of-bounds table lookups.</p> </li> <li> <p><code>calculate_temperature_profile()</code> (<code>eos_functions.py</code>): Returns a callable \\(T(r)\\) for three modes: <code>\"isothermal\"</code> (uniform), <code>\"linear\"</code> (center-to-surface gradient), or <code>\"prescribed\"</code> (loaded from file).</p> </li> <li> <p><code>parse_eos_config()</code> (<code>zalmoxis.py</code>): Parses the <code>[EOS]</code> TOML section into a per-layer dictionary.   Handles both the new per-layer format and legacy global-string format via <code>LEGACY_EOS_MAP</code>.</p> </li> <li> <p><code>validate_layer_eos()</code> (<code>zalmoxis.py</code>): Validates that all per-layer EOS strings correspond to known tabulated or analytic options.</p> </li> </ul>"},{"location":"model/#error-handling-in-the-ode-system","title":"Error handling in the ODE system","text":"<p>The adaptive ODE solver (RK45) evaluates the right-hand side at trial points that may be non-physical (e.g., negative pressure). Two mechanisms prevent crashes:</p> <ol> <li> <p>Zero-derivative guard in <code>coupled_odes()</code>: If the pressure or density is non-physical, the function returns \\([0, 0, 0]\\) instead of raising an exception.    This makes the local error estimate large, causing the solver to reject the trial step and retry with a smaller step size.</p> </li> <li> <p>Terminal event in <code>solve_structure()</code>: A terminal event <code>_pressure_zero</code> stops the integration when \\(P\\) crosses zero from above.    This prevents the solver from wasting time in the zero-derivative region and enables the Brent residual function to detect that \\(P_c\\) was too low.</p> </li> </ol> <p>These two mechanisms work together: the zero-derivative guard handles transient non-physical trial points within valid integrations, while the terminal event handles structurally too-low central pressure guesses.</p>"},{"location":"testing/","title":"Testing","text":"<p>Zalmoxis uses pytest with pytest-xdist for parallel execution. Tests are organized by speed and purpose into three categories using pytest markers.</p>"},{"location":"testing/#prerequisites","title":"Prerequisites","text":"<p>Install the development dependencies (includes pytest, pytest-xdist, ruff, and coverage tools):</p> <pre><code>pip install -e \".[develop]\"\n</code></pre> <p>The <code>ZALMOXIS_ROOT</code> environment variable must be set (see Installation). Tests validate this at session start and exit immediately if it is missing.</p>"},{"location":"testing/#running-tests","title":"Running tests","text":""},{"location":"testing/#by-marker","title":"By marker","text":"<p>Tests are categorized with markers that reflect their runtime and purpose:</p> Marker Tests Runtime What it validates <code>unit</code> 27 &lt; 2 s EOS functions, edge cases, analytic vs. tabulated consistency. No solver calls. <code>integration</code> 29 ~10--20 min Full solver runs: mass-radius relations, density profiles, analytic vs. tabulated MR, T-dependent EOS convergence. <code>slow</code> 2 ~30+ min Ternary composition grid sweep across core/mantle/water fractions. <p>Run a specific category:</p> <pre><code>pytest -m unit                # Fast feedback during development\npytest -m integration         # Full solver validation\npytest -m slow                # Composition grid sweep (pre-release)\npytest -m \"not slow\"          # Everything except the slow grid sweep\npytest -m \"unit or integration\"  # All except slow\n</code></pre>"},{"location":"testing/#all-tests","title":"All tests","text":"<pre><code>pytest                        # Runs all 58 tests in parallel\n</code></pre> <p>The default configuration (<code>pyproject.toml</code>) includes <code>-n auto --dist loadfile</code>, which distributes test files across CPU cores for parallel execution via pytest-xdist.</p>"},{"location":"testing/#single-test","title":"Single test","text":"<pre><code>pytest src/tests/test_MR.py::test_mass_radius[rocky-1]\n</code></pre>"},{"location":"testing/#without-parallelization","title":"Without parallelization","text":"<p>If you need serial execution (e.g., for debugging):</p> <pre><code>pytest -o \"addopts=-ra -v\" -m unit\n</code></pre> <p>This overrides the default <code>-n auto</code> flag.</p>"},{"location":"testing/#test-suite-overview","title":"Test suite overview","text":""},{"location":"testing/#unit-tests-test_analytic_eospy","title":"Unit tests (<code>test_analytic_eos.py</code>)","text":"<p>Validates the Seager et al. (2007) analytic modified polytropic EOS (<code>get_analytic_density()</code>) without invoking the planetary structure solver:</p> <ul> <li>Basic correctness: zero-pressure limit, monotonicity, iron at Earth-center pressure, cross-material density ordering.</li> <li>Edge cases: invalid material key, negative/zero/NaN pressure, high-pressure warning.</li> <li>Analytic vs. tabulated: compares the analytic fit against tabulated EOS data for iron, MgSiO3, and H2O within 15% tolerance.</li> </ul>"},{"location":"testing/#integration-tests","title":"Integration tests","text":"<p>Four test files run the full 3-level nested solver (structure ODE + density-pressure Picard iteration + mass-radius outer loop):</p> <p><code>test_MR.py</code> -- Mass-radius validation against Zeng et al. (2019) for rocky and water planets at 1, 5, 10, and 50 \\(M_\\oplus\\). Tolerance: 3% relative error.</p> <p><code>test_Seager.py</code> -- Density profile validation against Seager et al. (2007) radial profiles for rocky and water planets. Masks the core-mantle boundary discontinuity; tolerance: 24% relative error.</p> <p><code>test_analytic_MR.py</code> -- Compares analytic EOS against tabulated EOS using the full solver:</p> <ul> <li>Rocky planet (iron/MgSiO3): analytic vs. tabulated radii within 5%.</li> <li>Water planet (iron/MgSiO3/H2O): same comparison for 3-layer models.</li> <li>Exotic compositions (iron/SiC, iron/graphite): convergence check.</li> <li>Mixed EOS (tabulated core + analytic mantle): consistency within 5%.</li> </ul> <p>Uses a session-scoped solver cache (see Fixtures) to avoid redundant solver runs when the same configuration appears in multiple test classes.</p> <p><code>test_convergence_TdepEOS.py</code> -- Validates convergence of the temperature-dependent Wolf &amp; Bower (2018) EOS for 1 and 2 \\(M_\\oplus\\) planets. Checks physically plausible density ranges: iron core 8,000--50,000 kg/m\\(^3\\), MgSiO3 mantle 2,000--8,000 kg/m\\(^3\\).</p>"},{"location":"testing/#slow-tests-test_convergencepy","title":"Slow tests (<code>test_convergence.py</code>)","text":"<p>Sweeps a ternary composition grid (core, mantle, water mass fractions) at <code>step=0.2</code> for 1 and 10 \\(M_\\oplus\\). This produces ~21 grid points per mass value, testing convergence across corners (pure compositions), edges (binary mixtures), and interior points of the composition triangle. Verifies that all physically valid compositions converge.</p> <p>The step size is configurable via <code>run_ternary_grid_for_mass(mass, step=...)</code>. The default for the plotting code is <code>step=0.05</code> (~231 grid points); the test uses <code>step=0.2</code> for faster CI feedback while still covering the composition space.</p>"},{"location":"testing/#test-file-structure","title":"Test file structure","text":"<pre><code>src/tests/\n\u251c\u2500\u2500 conftest.py                   # Shared fixtures (env validation, solver cache)\n\u251c\u2500\u2500 test_analytic_eos.py          # Unit tests (27 tests, no solver)\n\u251c\u2500\u2500 test_analytic_MR.py           # Integration: analytic vs. tabulated MR\n\u251c\u2500\u2500 test_MR.py                    # Integration: mass-radius vs. Zeng (2019)\n\u251c\u2500\u2500 test_Seager.py                # Integration: density profiles vs. Seager (2007)\n\u251c\u2500\u2500 test_convergence_TdepEOS.py   # Integration: T-dependent EOS convergence\n\u2514\u2500\u2500 test_convergence.py           # Slow: ternary composition grid sweep\n</code></pre> <p>Test helpers (solver wrappers, reference data loaders) are in <code>src/tools/setup_tests.py</code>.</p>"},{"location":"testing/#fixtures","title":"Fixtures","text":"<p>Shared fixtures are defined in <code>src/tests/conftest.py</code>:</p>"},{"location":"testing/#_validate_environment-autouse-session","title":"<code>_validate_environment</code> (autouse, session)","text":"<p>Validates that <code>ZALMOXIS_ROOT</code> is set at the start of the test session. Calls <code>pytest.exit()</code> if missing, providing a clear error message instead of per-file <code>RuntimeError</code> raises.</p>"},{"location":"testing/#zalmoxis_root-session","title":"<code>zalmoxis_root</code> (session)","text":"<p>Returns the <code>ZALMOXIS_ROOT</code> path. Used by tests that need the repository root for log file paths or data directories.</p>"},{"location":"testing/#cached_solver-session","title":"<code>cached_solver</code> (session)","text":"<p>A session-scoped callable that wraps <code>run_zalmoxis_rocky_water()</code> with transparent caching. Identical parameter combinations (mass, config type, composition fractions, EOS override) return the same output file paths without re-running the solver.</p> <p>This eliminates redundant solver runs when multiple test classes share a baseline configuration. For example, <code>TestAnalyticVsTabulatedMR</code> and <code>TestMixedEOS</code> both need the tabulated rocky baseline at each mass -- the cache ensures it runs once.</p> <p>The cache key is <code>(mass, config_type, cmf, immf, eos_override_tuple)</code>. With <code>--dist loadfile</code> (the default), all tests in a file share one xdist worker and therefore one cache instance.</p>"},{"location":"testing/#parallelization","title":"Parallelization","text":"<p>Tests run in parallel via pytest-xdist with <code>--dist loadfile</code>, which groups all tests from the same file onto one worker. This ensures:</p> <ul> <li>The <code>cached_solver</code> fixture works correctly (session-scoped per worker, all tests in a file share one worker).</li> <li>Module-level imports and setup run once per file, not per test.</li> <li>Different test files run concurrently on separate CPU cores.</li> </ul> <p>With 6 test files and <code>loadfile</code> distribution, the suite uses up to 6 workers. The bottleneck is typically the slowest file (<code>test_convergence.py</code>).</p>"},{"location":"testing/#linting","title":"Linting","text":"<p>Before committing, format and check all test files:</p> <pre><code>ruff check --fix src/tests/\nruff format src/tests/\n</code></pre>"},{"location":"testing/#coverage","title":"Coverage","text":"<pre><code>pytest --cov=src --cov-report=html -m \"not slow\"\n</code></pre> <p>Open <code>htmlcov/index.html</code> to inspect line-by-line coverage.</p>"},{"location":"usage/","title":"Usage","text":""},{"location":"usage/#quick-start","title":"Quick Start","text":"<p>Run an Earth-like rocky planet with the default configuration:</p> <pre><code>python -m zalmoxis -c input/default.toml\n</code></pre> <p>This uses the default <code>input/default.toml</code>, which models a 1 Earth-mass, two-layer planet (iron core + MgSiO3 mantle). Output files are written to the <code>output_files/</code> directory.</p> <p>To change the planet mass, edit the <code>[InputParameter]</code> section:</p> <pre><code>[InputParameter]\nplanet_mass = 5.0  # in Earth masses\n</code></pre>"},{"location":"usage/#configuration","title":"Configuration","text":"<p>The full configuration is specified in a TOML file. The key sections are described below. See <code>input/default.toml</code> for all available parameters and their defaults.</p>"},{"location":"usage/#eos-configuration","title":"EOS Configuration","text":"<p>Each layer's equation of state is set independently in the <code>[EOS]</code> section. The format is <code>\"&lt;source&gt;:&lt;composition&gt;\"</code> for each layer. Set <code>ice_layer</code> to an empty string (or omit it) for a two-layer model; set it to a valid EOS string for a three-layer model.</p> <p>Valid EOS values:</p> EOS string Description <code>Seager2007:iron</code> Seager et al. (2007) tabulated Fe epsilon (300 K) <code>Seager2007:MgSiO3</code> Seager et al. (2007) tabulated MgSiO3 perovskite (300 K) <code>Seager2007:H2O</code> Seager et al. (2007) tabulated water ice (300 K) <code>WolfBower2018:MgSiO3</code> Wolf &amp; Bower (2018) RTpress T-dependent MgSiO3 (solid from Mosenfelder et al. 2009; melt), &lt;= 7 M_earth <code>RTPress100TPa:MgSiO3</code> Extended RTpress melt (100 TPa) + WB2018 solid (1 TPa clamped), T-dependent, &lt;= 50 M_earth <code>Analytic:&lt;material&gt;</code> Seager et al. (2007) analytic polytrope (300 K, no data files needed) <p>Valid analytic materials: <code>iron</code>, <code>MgSiO3</code>, <code>MgFeSiO3</code>, <code>H2O</code>, <code>graphite</code>, <code>SiC</code>.</p>"},{"location":"usage/#temperature-modes","title":"Temperature Modes","text":"<p>The <code>temperature_mode</code> parameter in <code>[AssumptionsAndInitialGuesses]</code> controls how the internal temperature profile is computed:</p> <ul> <li><code>\"isothermal\"</code>: Constant temperature equal to <code>surface_temperature</code> throughout the planet.</li> <li><code>\"linear\"</code>: Linear gradient from <code>center_temperature</code> (at the center) to <code>surface_temperature</code> (at the surface).</li> <li><code>\"prescribed\"</code>: Read from a file specified by <code>temperature_profile_file</code>.</li> </ul> <p>Temperature-dependent EOS (<code>WolfBower2018:MgSiO3</code> or <code>RTPress100TPa:MgSiO3</code>) requires one of these modes to be set. The 300 K tabulated and analytic EOS options ignore the temperature profile but still require valid mode settings in the config.</p>"},{"location":"usage/#temperature-profile-file-format","title":"Temperature Profile File Format","text":"<p>When using <code>temperature_mode = \"prescribed\"</code>, the file specified by <code>temperature_profile_file</code> must be a plain text file with one column of temperature values (in K), one value per radial grid point, ordered from the planet center to the surface. The number of values must equal <code>num_layers</code> in the <code>[Calculations]</code> section.</p> <p>Example for <code>num_layers = 5</code>:</p> <pre><code>6000.0\n5500.0\n4500.0\n3200.0\n2000.0\n</code></pre> <p>The file must be placed in the <code>input/</code> directory.</p>"},{"location":"usage/#example-configurations","title":"Example Configurations","text":""},{"location":"usage/#earth-like-rocky-planet","title":"Earth-like rocky planet","text":"<p>A fully differentiated two-layer planet with a 32.5% iron core and a cold (300 K) MgSiO3 perovskite mantle, following Seager et al. (2007).</p> <pre><code>[InputParameter]\nplanet_mass = 1.0\n\n[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.325\nmantle_mass_fraction = 0\n\n[EOS]\ncore = \"Seager2007:iron\"\nmantle = \"Seager2007:MgSiO3\"\nice_layer = \"\"\n</code></pre>"},{"location":"usage/#hot-rocky-planet-temperature-dependent-mantle","title":"Hot rocky planet (temperature-dependent mantle)","text":"<p>Same iron core, but the mantle uses the Wolf &amp; Bower (2018) temperature-dependent MgSiO3 EOS. The mantle can be solid, partially molten, or fully molten depending on local pressure and temperature. This is in contrast to the 300 K EOS from Seager et al. (2007), which represents a purely solid mantle.</p> <pre><code>[InputParameter]\nplanet_mass = 1.0\n\n[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.325\nmantle_mass_fraction = 0\ntemperature_mode = \"isothermal\"\nsurface_temperature = 2000\ncenter_temperature = 3000        # only used when temperature_mode = \"linear\"\ntemperature_profile_file = \"temp_profile.txt\"  # only used when temperature_mode = \"prescribed\"\n\n[EOS]\ncore = \"Seager2007:iron\"\nmantle = \"WolfBower2018:MgSiO3\"\nice_layer = \"\"\n</code></pre> <p>For a linear temperature gradient, set <code>temperature_mode = \"linear\"</code> and specify both <code>surface_temperature</code> and <code>center_temperature</code>. For a custom profile from file, set <code>temperature_mode = \"prescribed\"</code> and provide the file name in <code>temperature_profile_file</code>.</p>"},{"location":"usage/#water-rich-planet","title":"Water-rich planet","text":"<p>A fully differentiated three-layer planet: 6.5% iron core, 48.5% silicate mantle, and 45% outer water-ice layer by mass.</p> <pre><code>[InputParameter]\nplanet_mass = 1.0\n\n[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.065\nmantle_mass_fraction = 0.485\n\n[EOS]\ncore = \"Seager2007:iron\"\nmantle = \"Seager2007:MgSiO3\"\nice_layer = \"Seager2007:H2O\"\n</code></pre>"},{"location":"usage/#mixed-eos-tabulated-core-analytic-mantle","title":"Mixed EOS: tabulated core + analytic mantle","text":"<p>Tabulated iron core with an analytic Seager et al. (2007) silicate mantle. The analytic EOS requires no data files and uses a modified polytropic fit accurate to 2--12% for all planetary pressures.</p> <pre><code>[EOS]\ncore = \"Seager2007:iron\"\nmantle = \"Analytic:MgSiO3\"\nice_layer = \"\"\n</code></pre>"},{"location":"usage/#carbon-planet","title":"Carbon planet","text":"<p>An analytic iron core with an analytic silicon carbide mantle.</p> <pre><code>[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.30\nmantle_mass_fraction = 0\n\n[EOS]\ncore = \"Analytic:iron\"\nmantle = \"Analytic:SiC\"\nice_layer = \"\"\n</code></pre>"},{"location":"usage/#water-world-with-tabulated-core-and-mantle","title":"Water world with tabulated core and mantle","text":"<p>Tabulated iron core and silicate mantle with an analytic H2O outer layer.</p> <pre><code>[AssumptionsAndInitialGuesses]\ncore_mass_fraction = 0.10\nmantle_mass_fraction = 0.40\n\n[EOS]\ncore = \"Seager2007:iron\"\nmantle = \"Seager2007:MgSiO3\"\nice_layer = \"Analytic:H2O\"\n</code></pre>"},{"location":"usage/#output-description","title":"Output Description","text":"<p>All output files are written to the <code>output_files/</code> directory.</p>"},{"location":"usage/#profile-files","title":"Profile files","text":"<ul> <li><code>planet_profile.txt</code>: Full radial profile for a single-mass run. Columns: radius (m), density (kg/m^3), gravity (m/s^2), pressure (Pa), temperature (K), mass enclosed (kg).</li> <li><code>planet_profile{mass}.txt</code>: Same format, but with the planet mass (in Earth masses) appended to the filename. Produced by parallel batch runs to distinguish between different masses.</li> </ul>"},{"location":"usage/#summary-file","title":"Summary file","text":"<ul> <li><code>calculated_planet_mass_radius.txt</code>: Two-column summary (calculated mass in kg, calculated radius in m). Each row corresponds to one completed simulation. Appended across successive runs.</li> </ul>"},{"location":"usage/#iteration-profiles-optional","title":"Iteration profiles (optional)","text":"<p>When <code>iteration_profiles_enabled = true</code> in the <code>[Output]</code> section:</p> <ul> <li><code>pressure_profiles.txt</code>: Pressure vs. radius for every iteration of the pressure adjustment loop.</li> <li><code>density_profiles.txt</code>: Density vs. radius for every iteration.</li> </ul> <p>These files are useful for diagnosing convergence behavior. They are overwritten at the start of each new run.</p>"},{"location":"usage/#plots-optional","title":"Plots (optional)","text":"<p>When <code>plots_enabled = true</code> in the <code>[Output]</code> section, PDF plots of the radial profiles (density, gravity, pressure, temperature) are generated automatically after each run. If a temperature-dependent mantle EOS (<code>WolfBower2018:MgSiO3</code> or <code>RTPress100TPa:MgSiO3</code>) is used, an additional pressure-temperature phase diagram with mantle phase information is produced.</p>"},{"location":"usage/#running-zalmoxis-in-parallel-for-multiple-masses","title":"Running Zalmoxis in parallel for multiple masses","text":"<p>To run Zalmoxis over a range of planetary masses in parallel, use the <code>run_parallel.py</code> utility:</p> <pre><code>python -m src.tools.run_parallel [choice]\n</code></pre> <p>where <code>[choice]</code> specifies the set of planetary masses to simulate. The available options are:</p> <ul> <li><code>Wagner</code>: 7 rocky planets with masses of 1, 2.5, 5, 7.5, 10, 12.5, and 15 Earth masses, following Wagner et al. (2012).</li> <li><code>Boujibar</code>: Integer masses from 1 to 10 Earth masses, following Boujibar et al. (2020).</li> <li><code>default</code>: Masses from 1 to 10 Earth masses in unit steps. Fallback if no option is provided.</li> <li><code>SeagerEarth</code>: Masses of 1, 5, 10, and 50 Earth masses, following Seager et al. (2007). Use with the Earth-like rocky planet configuration.</li> <li><code>Seagerwater</code>: Same masses as <code>SeagerEarth</code>. Use with the water-rich planet configuration.</li> <li><code>custom</code>: Integer masses from 1 to 50 Earth masses, for generating high-resolution mass-radius curves.</li> </ul> <p>All parallel runs read from <code>input/default.toml</code> and override the planet mass for each run. Each mass produces its own <code>planet_profile{mass}.txt</code> file, and all results are collected in <code>calculated_planet_mass_radius.txt</code>.</p>"}]}